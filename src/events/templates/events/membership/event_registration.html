{% extends "events/membership/base.html" %}

{% block title %}{{ event.event_name|default:"Event Registration" }} | Innovate to Grow{% endblock %}

{% block content %}
<section class="membership-card">
  {% if error_message %}
    <h1 class="membership-title">Event Registration</h1>
    <hr class="membership-divider">
    <div class="alert alert-error">{{ error_message }}</div>
    <div class="membership-actions">
      <a class="btn-secondary" href="/membership/events">Back to Event Entry</a>
    </div>
  {% else %}
    <h1 class="membership-title">{{ event.event_name }} Registration</h1>
    <p class="membership-subtitle">Review your details and submit your registration.</p>
    <hr class="membership-divider">

    <div id="registration-error" class="alert alert-error hidden"></div>
    <div id="registration-success" class="alert alert-success hidden">
      Registration submitted successfully
    </div>

    <form id="event-registration-form" class="membership-form">
      <input type="hidden" id="token" value="{{ token }}">
      <input type="hidden" id="event-slug" value="{{ event_slug }}">

      <div class="membership-grid-2">
        <div class="membership-field">
          <label for="first_name">First Name</label>
          <input class="membership-input" id="first_name" name="first_name" type="text" value="{{ payload.member.first_name }}">
        </div>
        <div class="membership-field">
          <label for="last_name">Last Name</label>
          <input class="membership-input" id="last_name" name="last_name" type="text" value="{{ payload.member.last_name }}">
        </div>
      </div>

      <div class="membership-grid-2">
        <div class="membership-field">
          <label for="primary_email">Primary Email</label>
          <input class="membership-input" id="primary_email" name="primary_email" type="email" value="{{ payload.member.primary_email }}" readonly>
        </div>
        <div class="membership-field">
          <label for="secondary_email">Secondary Email</label>
          <input class="membership-input" id="secondary_email" name="secondary_email" type="email" value="{{ payload.member.secondary_email }}">
        </div>
      </div>

      <div class="membership-field">
        <label for="ticket_option_id">Ticket Type</label>
        <select class="membership-select" id="ticket_option_id" name="ticket_option_id">
          <option value="">Select a ticket type</option>
          {% for option in payload.schema.ticket_options %}
            <option
              value="{{ option.id }}"
              {% if option.id == payload.registration.ticket_option_id %}selected{% endif %}
            >
              {{ option.label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="membership-grid-2">
        <div class="membership-field">
          <label for="phone_region">Phone Region</label>
          <input class="membership-input" id="phone_region" name="phone_region" type="text" placeholder="1-US" value="1-US">
        </div>
        <div class="membership-field">
          <label for="phone_number">Phone Number</label>
          <input class="membership-input" id="phone_number" name="phone_number" type="text" value="{{ payload.registration.phone_number }}" placeholder="2095551234">
        </div>
      </div>

      <label class="membership-checkbox">
        <input id="primary_email_subscribed" name="primary_email_subscribed" type="checkbox" {% if payload.registration.primary_email_subscribed %}checked{% endif %}>
        <span>Subscribe primary email for event updates</span>
      </label>
      <label class="membership-checkbox">
        <input id="secondary_email_subscribed" name="secondary_email_subscribed" type="checkbox" {% if payload.registration.secondary_email_subscribed %}checked{% endif %}>
        <span>Subscribe secondary email for event updates</span>
      </label>
      <label class="membership-checkbox">
        <input id="phone_subscribed" name="phone_subscribed" type="checkbox" {% if payload.registration.phone_subscribed %}checked{% endif %}>
        <span>Subscribe phone for SMS updates (OTP verification required)</span>
      </label>

      {% if payload.schema.questions %}
        <hr class="membership-divider">
        {% for question in payload.schema.questions %}
          <div class="membership-field">
            <label for="question_{{ question.id }}">{{ question.prompt }}{% if question.required %} *{% endif %}</label>
            <textarea
              class="membership-textarea question-input"
              id="question_{{ question.id }}"
              data-question-id="{{ question.id }}"
              data-question-prompt="{{ question.prompt|escape }}"
              data-required="{{ question.required|yesno:'true,false' }}"
              name="question_{{ question.id }}"
            >{{ question.answer_text }}</textarea>
          </div>
        {% endfor %}
      {% endif %}

      <div class="membership-actions">
        <button id="submit-btn" class="btn-primary" type="submit">Submit Registration</button>
        <a class="btn-secondary" href="/membership/events/{{ event_slug }}">Back</a>
      </div>
    </form>
  {% endif %}
</section>

{% if not error_message %}
  {{ payload|json_script:"registration-payload" }}
  <script>
    (function () {
      const form = document.getElementById("event-registration-form");
      const errorBox = document.getElementById("registration-error");
      const successBox = document.getElementById("registration-success");
      const submitBtn = document.getElementById("submit-btn");
      const token = document.getElementById("token").value;
      const eventSlug = document.getElementById("event-slug").value;

      function setError(message) {
        errorBox.textContent = message || "Failed to submit registration.";
        errorBox.classList.remove("hidden");
      }

      function clearMessages() {
        errorBox.classList.add("hidden");
        successBox.classList.add("hidden");
      }

      form.addEventListener("submit", async function (event) {
        event.preventDefault();
        clearMessages();
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        const answers = Array.from(document.querySelectorAll(".question-input")).map((node) => {
          return {
            question_id: node.dataset.questionId || null,
            question_prompt: node.dataset.questionPrompt || "",
            answer_text: node.value || "",
          };
        });

        const payload = {
          token,
          first_name: document.getElementById("first_name").value || "",
          last_name: document.getElementById("last_name").value || "",
          primary_email: document.getElementById("primary_email").value || "",
          secondary_email: document.getElementById("secondary_email").value || "",
          primary_email_subscribed: document.getElementById("primary_email_subscribed").checked,
          secondary_email_subscribed: document.getElementById("secondary_email_subscribed").checked,
          ticket_option_id: document.getElementById("ticket_option_id").value || null,
          phone_region: document.getElementById("phone_region").value || "",
          phone_number: document.getElementById("phone_number").value || "",
          phone_subscribed: document.getElementById("phone_subscribed").checked,
          answers,
        };

        try {
          const response = await fetch("/events/registration/submit/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });
          const data = await response.json();

          if (!response.ok) {
            setError(data.error || "Registration submission failed.");
            return;
          }

          if (data.otp_required) {
            window.location.href = "/membership/otp/" + encodeURIComponent(token) + "?event_slug=" + encodeURIComponent(eventSlug);
            return;
          }

          successBox.classList.remove("hidden");
          successBox.textContent = "Registration submitted successfully.";
        } catch (err) {
          setError("Network error while submitting registration.");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit Registration";
        }
      });
    })();
  </script>
{% endif %}
{% endblock %}
