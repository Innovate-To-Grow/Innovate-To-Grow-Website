{% load i18n admin_urls %}

<div {% if not is_popup %}id="submit-row"{% endif %} class="relative lg:sticky lg:bottom-0 z-40">
    <div class="backdrop-blur-xs bg-white/80 rounded-b-default pb-4 px-4 dark:bg-base-900/80 lg:border-t lg:border-base-200 relative lg:scrollable-top lg:py-0 dark:border-base-800">
        <div class="flex flex-col-reverse gap-3 items-center mx-auto lg:flex-row-reverse container lg:h-[64px]">
            {% block submit-row %}
                {% if show_save %}
                    <button type="submit" form="{{ opts.model_name }}_form" name="_save" class="bg-primary-600 block border border-transparent cursor-pointer font-medium px-3 py-2 rounded-default text-white w-full lg:w-auto">
                        {% translate 'Save' %}
                    </button>
                {% endif %}

                {% for action in actions_submit_line %}
                    <button type="submit" form="{{ opts.model_name }}_form" {% if not action.attrs.name %}name="{{ action.action_name }}"{% endif %} class="border border-base-200 cursor-pointer flex font-medium gap-2 items-center justify-center px-3 py-2 rounded-default transition-all w-full hover:bg-base-50 lg:w-auto dark:border-base-700 dark:hover:text-base-200 dark:hover:bg-base-900" {% include "unfold/helpers/attrs.html" with attrs=action.attrs %}>
                        {% if action.icon %}
                            <span class="material-symbols-outlined">
                                {{ action.icon }}
                            </span>
                        {% endif %}

                        {{ action.description }}
                    </button>
                {% endfor %}

                {% if show_save_and_continue %}
                    <button type="submit" form="{{ opts.model_name }}_form" name="_continue" class="border border-base-200 cursor-pointer font-medium px-3 py-2 rounded-default transition-all w-full hover:bg-base-50 lg:block lg:w-auto dark:border-base-700  dark:hover:text-base-200 dark:hover:bg-base-900">
                        {% if can_change %}
                            {% translate 'Save and continue editing' %}
                        {% else %}
                            {% translate 'Save and view' %}
                        {% endif %}
                    </button>
                {% endif %}

                {% if show_save_and_add_another %}
                    <button type="submit" form="{{ opts.model_name }}_form" name="_addanother" class="border border-base-200 cursor-pointer font-medium px-3 py-2 rounded-default transition-all w-full hover:bg-base-50 lg:block lg:w-auto dark:border-base-700  dark:hover:text-base-200 dark:hover:bg-base-900">
                        {% translate 'Save and add another' %}
                    </button>
                {% endif %}

                {% if not is_popup %}
                <div class="admin-autosave-control border border-base-200 cursor-pointer flex font-medium gap-2 items-center justify-center px-3 py-2 rounded-default transition-all w-full hover:bg-base-50 lg:flex lg:w-auto dark:border-base-700 dark:hover:text-base-200 dark:hover:bg-base-900">
                    <label class="admin-autosave-toggle inline-flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="admin-autosave-toggle" class="admin-autosave-checkbox sr-only">
                        <span class="admin-autosave-switch">
                            <span class="admin-autosave-knob"></span>
                        </span>
                        <span class="admin-autosave-label">{% translate "Auto Save" %}</span>
                    </label>
                    <span id="admin-autosave-status" class="admin-autosave-status" aria-live="polite"></span>
                </div>
                {% endif %}

                {% if show_save_as_new %}
                    <button type="submit" form="{{ opts.model_name }}_form" name="_saveasnew" class="border border-base-200 cursor-pointer font-medium px-3 py-2 rounded-default transition-all w-full hover:bg-base-50 lg:block lg:w-auto dark:border-base-700  dark:hover:text-base-200 dark:hover:bg-base-900">
                        {% translate 'Save as new' %}
                    </button>
                {% endif %}

                <div class="flex flex-col gap-3 mr-auto w-full lg:flex-row lg:w-auto lg:items-center">
                    {% if show_close or adminform.model_admin.change_form_show_cancel_button %}
                        {% url opts|admin_urlname:'changelist' as changelist_url %}

                        <a href="{% add_preserved_filters changelist_url %}" class="border border-base-200 cursor-pointer font-medium px-3 py-2 rounded-default text-center transition-all w-full hover:bg-base-50 lg:block lg:w-auto dark:border-base-700 dark:hover:text-base-200 dark:hover:bg-base-900">
                            {% translate 'Close' %}
                        </a>
                    {% endif %}

                    {% if show_delete_link and original %}
                        {% url opts|admin_urlname:'delete' original.pk|admin_urlquote as delete_url %}

                        <a href="{% add_preserved_filters delete_url %}" class="bg-red-600 cursor-pointer flex items-center justify-center font-medium h-[38px] ml-auto px-3 py-2 rounded-default text-center text-white w-full lg:w-auto dark:bg-red-500/20 dark:text-red-500">
                            {% translate "Delete" %} {{ opts.verbose_name }}
                        </a>
                    {% endif %}
                </div>
            {% endblock %}
        </div>
    </div>
</div>

{% if not is_popup %}
<style>
.admin-autosave-checkbox.sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
.admin-autosave-switch {
    display: inline-flex;
    align-items: center;
    width: 44px;
    height: 24px;
    padding: 2px;
    border-radius: 12px;
    background: #e5e7eb;
    border: 1px solid #d1d5db;
    transition: background 0.2s ease, border-color 0.2s ease;
    cursor: pointer;
}
.admin-autosave-switch .admin-autosave-knob {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
.admin-autosave-toggle .admin-autosave-checkbox:checked + .admin-autosave-switch {
    background: #9333ea;
    border-color: #7c3aed;
}
.admin-autosave-toggle .admin-autosave-checkbox:checked + .admin-autosave-switch .admin-autosave-knob {
    transform: translateX(20px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.admin-autosave-toggle .admin-autosave-checkbox:focus + .admin-autosave-switch {
    outline: 2px solid #9333ea;
    outline-offset: 2px;
}
.admin-autosave-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
}
.dark .admin-autosave-label { color: #e5e7eb; }
.dark .admin-autosave-switch { background: #4b5563; border-color: #6b7280; }
.dark .admin-autosave-toggle .admin-autosave-checkbox:checked + .admin-autosave-switch { background: #7c3aed; border-color: #9333ea; }
.admin-autosave-status {
    font-size: 0.75rem;
    color: #6b7280;
}
.admin-autosave-status.saving { color: #6b7280; font-style: italic; }
.admin-autosave-status.saved { color: #059669; }
.admin-autosave-status.error { color: #dc2626; }
</style>
<script>
(function() {
    var STORAGE_KEY = 'admin_autosave_enabled';
    var INTERVAL_MS = 30000;
    var formId = '{{ opts.model_name }}_form';
    var form = document.getElementById(formId);
    if (!form) return;

    var toggle = document.getElementById('admin-autosave-toggle');
    var statusEl = document.getElementById('admin-autosave-status');
    var timer = null;
    var lastSavedState = '';

    function setStatus(text, klass) {
        if (!statusEl) return;
        statusEl.textContent = text;
        statusEl.className = 'admin-autosave-status text-xs ' + (klass || '');
    }

    function getFormState() {
        var fd = new FormData(form);
        var pairs = [];
        for (var pair of fd.entries()) {
            if (pair[0] !== '_continue') pairs.push(pair[0] + '=' + (pair[1] || ''));
        }
        pairs.sort();
        return pairs.join('&');
    }

    function loadPreference() {
        try {
            return localStorage.getItem(STORAGE_KEY) === '1';
        } catch (e) { return false; }
    }
    function savePreference(on) {
        try { localStorage.setItem(STORAGE_KEY, on ? '1' : '0'); } catch (e) {}
    }

    function doAutoSave() {
        if (!form || !toggle || !toggle.checked) return;
        var currentState = getFormState();
        if (currentState === lastSavedState) return;
        setStatus('{% translate "Auto saving..." %}', 'saving');

        var fd = new FormData(form);
        fd.append('_continue', '1');

        fetch(form.action || window.location.href, {
            method: 'POST',
            body: fd,
            redirect: 'follow',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(function(res) {
            if (res.ok) {
                lastSavedState = getFormState();
                var now = new Date();
                var timeStr = now.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
                setStatus('{% translate "Saved at" %} ' + timeStr, 'saved');
                var currentPath = window.location.pathname + window.location.search;
                if (res.url && res.url !== window.location.href && currentPath.indexOf('/add/') !== -1) {
                    window.location.href = res.url;
                }
            } else {
                setStatus('{% translate "Save failed" %}', 'error');
            }
        }).catch(function() {
            setStatus('{% translate "Save failed" %}', 'error');
        });
    }

    function scheduleNext() {
        if (timer) clearInterval(timer);
        timer = null;
        if (!toggle.checked) return;
        timer = setInterval(doAutoSave, INTERVAL_MS);
    }

    if (toggle) {
        lastSavedState = getFormState();
        toggle.checked = loadPreference();
        toggle.addEventListener('change', function() {
            var on = toggle.checked;
            savePreference(on);
            if (on) {
                doAutoSave();
                scheduleNext();
            } else {
                if (timer) clearInterval(timer);
                timer = null;
                setStatus('', '');
            }
        });
        if (toggle.checked) {
            lastSavedState = getFormState();
            scheduleNext();
        }
    }
})();
</script>
{% endif %}
